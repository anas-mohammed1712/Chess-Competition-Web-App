<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ProChess Manager v4.5 - Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø©</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --bg: #f4f7f6;
            --white: #ffffff;
        }

        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: var(--bg); margin: 0; padding: 20px; color: var(--primary); }
        .container { max-width: 1100px; margin: 0 auto; background: var(--white); padding: 30px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        
        h1, h2, h3 { border-bottom: 2px solid var(--bg); padding-bottom: 10px; }
        .section { margin-bottom: 30px; }
        
        input, textarea, select { width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; margin-top: 5px; margin-bottom: 15px; font-size: 16px; }
        button { padding: 12px 20px; border-radius: 6px; border: none; cursor: pointer; font-weight: bold; transition: 0.3s; margin: 5px; }
        
        .btn-main { background: var(--accent); color: white; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-outline { background: transparent; border: 1px solid var(--accent); color: var(--accent); }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { text-align: right; padding: 12px; border-bottom: 1px solid #eee; }
        th { background: var(--bg); }

        .pairing-row { display: flex; align-items: center; justify-content: space-between; padding: 15px; background: #fafafa; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; }
        .pairing-row select { width: auto; margin: 0 15px; }
        
        .bye-notice { background: #fff3cd; color: #856404; padding: 12px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #ffeeba; font-weight: bold; }
        .history-card { background: #fdfdfd; padding: 20px; border: 1px solid #e0e0e0; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .archive-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border: 1px solid #eee; margin-bottom: 10px; border-radius: 8px; background: #fff; }
        
        .hidden { display: none; }
        .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; }
        .w { background: #eee; color: #333; } .b { background: #333; color: #eee; }
        .site-label { font-size: 10px; color: #7f8c8d; background: #ebedef; padding: 2px 5px; border-radius: 3px; }
        
        @media print { .no-print { display: none !important; } }
        #transferSection {
    margin-top: 20px;
    border-radius: 10px;
    transition: all 0.3s ease;
}

#transferSection h3 {
    border: none;
    margin: 0;
}

.hidden {
    display: none;
}
    </style>
</head>
<body>

<div class="container">
    <div id="homeScreen" class="section">
        <h1>â™Ÿï¸ ProChess Manager Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ v4.5</h1>
        <button class="btn-main" onclick="showSection('setup')">Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø© +</button>
        <button class="btn-outline" onclick="loadArchive()">Ø³Ø¬Ù„ Ø§Ù„Ø¨Ø·ÙˆÙ„Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ğŸ“</button>
    </div>

    <div id="setup" class="section hidden">
        <button class="btn-outline no-print" onclick="showSection('homeScreen')">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        <h2>Ø¥Ø¹Ø¯Ø§Ø¯ Ø¨Ø·ÙˆÙ„Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
        <input type="text" id="tourneyName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¨Ø·ÙˆÙ„Ø©">
        <select id="format">
            <option value="swiss">Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø³ÙˆÙŠØ³Ø±ÙŠ (FIDE Swiss)</option>
            <option value="roundrobin">Ø§Ù„ÙƒÙ„ Ø¶Ø¯ Ø§Ù„ÙƒÙ„ (Round Robin)</option>
            <option value="cup">Ø®Ø±ÙˆØ¬ Ø§Ù„Ù…ØºÙ„ÙˆØ¨ (Ù…Ø¹ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø«)</option>
        </select>
        <p><small>ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„: <b>Ø§Ù„Ø§Ø³Ù…, Ø§Ù„ØªÙ‚ÙŠÙŠÙ…, Ø§Ù„Ù…Ù†ØµØ© (chess Ø£Ùˆ lichess)</b></small></p>
        <textarea id="playerList" rows="8" placeholder="Ø£Ø­Ù…Ø¯ Ø¹Ù„ÙŠ, 1800, lichess&#10;Ø³Ø§Ø±Ø© ÙŠÙˆØ³Ù, 1700, chess"></textarea>
        <button class="btn-success" onclick="initTournament()">Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¨Ø·ÙˆÙ„Ø©</button>
    </div>

    <div id="archive" class="section hidden">
        <button class="btn-outline" onclick="showSection('homeScreen')">â† Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        <h2>Ø§Ù„Ø¨Ø·ÙˆÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</h2>
        <div id="archiveList"></div>
    </div>

    <div id="tournamentArea" class="section hidden">
        <div class="no-print" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap;">
            <button class="btn-outline" onclick="confirmExit()">ğŸ  Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
            <h2 id="displayTourneyName">Ø§Ø³Ù… Ø§Ù„Ø¨Ø·ÙˆÙ„Ø©</h2>
            <div>
                <button class="btn-main" onclick="showHistory()">Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª ğŸ“œ</button>
                <button class="btn-success" onclick="manualSave()">Ø­ÙØ¸ Ø§Ù„Ø¨Ø·ÙˆÙ„Ø© ğŸ’¾</button>
            </div>
        </div>

        <div id="activeRoundView">
            <h3 id="roundTitle">Ø§Ù„Ø¬ÙˆÙ„Ø© 1</h3>
            <div id="byeContainer"></div>
            <div id="pairingsContainer"></div>
            
            <div class="no-print" style="margin-top: 20px;">
                <button id="nextRoundBtn" class="btn-main" onclick="generateNextRound()">ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ© Â»</button>
                <button class="btn-outline" onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
                <button class="btn-outline" onclick="window.print()">Ø·Ø¨Ø§Ø¹Ø©</button>
            </div>
        </div>

        <div id="historyView" class="hidden">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3>Ø³Ø¬Ù„ Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø¨Ø·ÙˆÙ„Ø© Ø§Ù„ÙƒØ§Ù…Ù„</h3>
                <button class="btn-danger" onclick="hideHistory()">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø³Ø¬Ù„ Ã—</button>
            </div>
            <div id="historyContent"></div>
        </div>

        <h2>Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</h2>
        <table id="standingsTable">
         <thead>
            <tr>
                <th>Ù…Ø±ÙƒØ²</th>
                <th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
                <th>Ø§Ù„ØªÙ‚ÙŠÙŠÙ…</th>
                <th>Ø§Ù„Ù†Ù‚Ø§Ø·</th>
                <th title="Performance Rating">Ù…Ø¹Ø¯Ù„ Ø§Ù„Ø£Ø¯Ø§Ø¡</th>
                <th id="tiebreakHeader">SB ÙƒØ³Ø± ØªØ¹Ø§Ø¯Ù„</th>
            </tr>
        </thead>
            
            <tbody></tbody>
        </table>
    </div>
    <button class="btn-outline" onclick="toggleTransferUI()">Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ø§Ø³ØªÙŠØ±Ø§Ø¯/ØªØµØ¯ÙŠØ±) âš™ï¸</button>

<div id="transferSection" class="section hidden" style="border: 2px dashed var(--accent); padding: 20px; background: #f9f9f9;">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <h3>Ù†Ø¸Ø§Ù… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
        <button class="btn-danger" onclick="toggleTransferUI()">Ø¥ØºÙ„Ø§Ù‚ Ã—</button>
    </div>
    
    <p>ÙŠÙ…ÙƒÙ†Ùƒ ØªØµØ¯ÙŠØ± Ø¨ÙŠØ§Ù†Ø§ØªÙƒ ÙƒÙ…Ù„Ù JSON Ù„Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©ØŒ Ø£Ùˆ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù…Ù„Ù Ø³Ø§Ø¨Ù‚.</p>
    
    <div style="display: flex; gap: 10px;">
        <button class="btn-main" onclick="exportData()">ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Download JSON) â†“</button>
        
        <button class="btn-success" onclick="document.getElementById('importFile').click()">Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª (Upload JSON) â†‘</button>
        <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importData(event)">
    </div>
</div>
</div>

<script>
/** Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù†Ø¸Ø§Ù… **/
let state = {
    id: null,
    name: "",
    players: [],
    rounds: [],
    currentRoundIdx: -1,
    format: '',
    maxRounds: 0,
    finished: false
};

function showSection(id) {
    document.querySelectorAll('.section').forEach(s => s.classList.add('hidden'));
    document.getElementById(id).classList.remove('hidden');
}

/** Ø¨Ø¯Ø¡ Ø§Ù„Ø¨Ø·ÙˆÙ„Ø© ÙˆØªØ­ÙˆÙŠÙ„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª **/
function initTournament() {
    const nameInput = document.getElementById('tourneyName').value.trim();
    const playerInput = document.getElementById('playerList').value.trim();
    if (!nameInput || !playerInput) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");

    let players = playerInput.split('\n').filter(l => l.trim() !== "").map((line, idx) => {
        let parts = line.split(',');
        let name = parts[0]?.trim() || `Ù„Ø§Ø¹Ø¨ ${idx + 1}`;
        let rawRating = parseInt(parts[1]) || 1200;
        let site = parts[2]?.trim().toLowerCase() || 'chess';
        let finalRating = (site === 'lichess') ? rawRating - 200 : rawRating;

        return {
            id: idx,
            name: name,
            rating: finalRating,
            displaySite: site,
            points: 0,
            sbScore: 0,
            opponents: [],
            receivedBye: false,
            colorBalance: 0,
            eliminated: false,
            lastRoundLost: -1
        };
    });

    state = {
        id: Date.now(),
        name: nameInput,
        players: players,
        rounds: [],
        currentRoundIdx: -1,
        format: document.getElementById('format').value,
        finished: false
    };

    if (state.format === 'roundrobin') state.maxRounds = (players.length % 2 === 0) ? players.length - 1 : players.length;
    else state.maxRounds = Math.ceil(Math.log2(players.length)) + 1; // Ø²ÙŠØ§Ø¯Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©

    document.getElementById('displayTourneyName').innerText = state.name;
    document.getElementById('tiebreakHeader').innerText = state.format === 'cup' ? 'Ø§Ù„Ø­Ø§Ù„Ø©' : 'SB ÙƒØ³Ø± ØªØ¹Ø§Ø¯Ù„';
    
    showSection('tournamentArea');
    generateNextRound();
}

/** ØªÙˆÙ„ÙŠØ¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª ÙˆØ§Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù€ Bye **/
function generateNextRound() {
    state.currentRoundIdx++;
    let byePlayer = null;
    let participants = [];

    if (state.format === 'cup') {
        participants = state.players.filter(p => !p.eliminated);
        if (participants.length === 1) {
            state.finished = true;
            renderUI(); return;
        }
    } else {
        participants = [...state.players];
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ù€ Bye: Ø§Ù„Ø£Ù‚Ù„ Ù†Ù‚Ø§Ø·Ø§Ù‹ Ø«Ù… Ø§Ù„Ø£Ù‚Ù„ ØªÙ‚ÙŠÙŠÙ…Ø§Ù‹
    if (participants.length % 2 !== 0) {
        let candidates = participants.filter(p => !p.receivedBye)
            .sort((a, b) => a.points - b.points || a.rating - b.rating);
        
        byePlayer = candidates.length > 0 ? candidates[0] : participants[participants.length - 1];
        byePlayer.receivedBye = true;
        participants = participants.filter(p => p.id !== byePlayer.id);
    }

    let pairings = [];
    if (state.format === 'swiss') pairings = pairSwiss(participants);
    else if (state.format === 'roundrobin') pairings = pairRoundRobin(participants);
    else pairings = pairCup(participants);

    state.rounds.push({ round: state.currentRoundIdx + 1, games: pairings, bye: byePlayer });
    calculateStats();
    renderUI();
}
/** Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø³ÙˆÙŠØ³Ø±ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø«Ø©: Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù„ÙˆÙ† Ù„Ù„Ù…Ø±Ø© Ø§Ù„Ø«Ø§Ù„Ø«Ø© (FIDE Strict) **/
function pairSwiss(parts) {
    let sorted = [...parts].sort((a, b) => b.points - a.points || b.rating - a.rating);
    let paired = [], used = new Set();

    // 1. Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ (FIDE Split)
    const isFirstRound = state.currentRoundIdx === 0;
    if (isFirstRound) {
        let half = Math.ceil(sorted.length / 2);
        let topHalf = sorted.slice(0, half);
        let bottomHalf = sorted.slice(half);
        for (let i = 0; i < topHalf.length; i++) {
            let white = topHalf[i], black = bottomHalf[i];
            if (black) {
                if (i % 2 !== 0) [white, black] = [black, white];
                paired.push({ white, black, result: null });
                used.add(white.id); used.add(black.id);
            }
        }
    }

    // 2. Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø²Ø§ÙˆØ¬Ø© Ù„Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…Ø¹ Ù‚ÙŠØ¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØµØ§Ø±Ù…
    for (let i = 0; i < sorted.length; i++) {
        if (used.has(sorted[i].id)) continue;
        let p1 = sorted[i], p2 = null;

        for (let j = i + 1; j < sorted.length; j++) {
            if (!used.has(sorted[j].id) && !p1.opponents.includes(sorted[j].id)) {
                p2 = sorted[j]; break;
            }
        }
        
        if (!p2) { // Ø¨Ø­Ø« Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ
            for (let j = i + 1; j < sorted.length; j++) if(!used.has(sorted[j].id)) { p2 = sorted[j]; break; }
        }

        if (p2) {
            let white, black;
            
            // --- Ù‚ÙŠØ¯ Ø§Ù„Ø£Ù„ÙˆØ§Ù† Ø§Ù„ØµØ§Ø±Ù… (Strict Color Constraint) ---
            // Ù†Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¢Ø®Ø± Ù„ÙˆÙ†ÙŠÙ† Ù„Ø¹Ø¨Ù‡Ù…Ø§ ÙƒÙ„ Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø³Ø¬Ù„ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª
            let p1LastTwo = getPlayerColorHistory(p1.id).slice(-2).join('');
            let p2LastTwo = getPlayerColorHistory(p2.id).slice(-2).join('');

            // Ø¥Ø°Ø§ Ù„Ø¹Ø¨ p1 Ù…Ø±ØªÙŠÙ† Ø£Ø¨ÙŠØ¶ØŒ ÙŠØ¬Ø¨ Ø£Ù† ÙŠØ£Ø®Ø° Ø£Ø³ÙˆØ¯ (Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† p2 Ø£ÙŠØ¶Ø§Ù‹ Ù„Ø¹Ø¨ Ù…Ø±ØªÙŠÙ† Ø£Ø³ÙˆØ¯ØŒ Ù‡Ù†Ø§ ØªÙ‚Ø¹ Ù…Ø¹Ø¶Ù„Ø© Ù‚Ø§Ù†ÙˆÙ†ÙŠØ©)
            if (p1LastTwo === 'WW' || p2LastTwo === 'BB') {
                white = p2; black = p1;
            } else if (p1LastTwo === 'BB' || p2LastTwo === 'WW') {
                white = p1; black = p2;
            } else {
                // Ø§Ù„Ù…ÙˆØ§Ø²Ù†Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ Ø®Ø·Ø± Ø§Ù„ØªÙƒØ±Ø§Ø± Ø§Ù„Ø«Ø§Ù„Ø«
                if (p1.colorBalance > p2.colorBalance) { white = p2; black = p1; }
                else { white = p1; black = p2; }
            }

            paired.push({ white, black, result: null });
            used.add(p1.id); used.add(p2.id);
        }
    }
    return paired;
}

/** Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ØªØ§Ø±ÙŠØ® Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© **/
function getPlayerColorHistory(playerId) {
    let history = [];
    state.rounds.forEach(r => {
        r.games.forEach(g => {
            if (g.white.id === playerId) history.push('W');
            if (g.black.id === playerId) history.push('B');
        });
    });
    return history;
}
/** Ø®ÙˆØ§Ø±Ø²Ù…ÙŠØ© Ø§Ù„Ø¯ÙˆØ±ÙŠ (Round Robin) **/
function pairRoundRobin(parts) {
    let circle = [...parts];
    const n = circle.length;
    const rot = state.currentRoundIdx;
    for(let i=0; i<rot; i++) circle.splice(1, 0, circle.pop());
    let paired = [];
    for (let i = 0; i < n / 2; i++) {
        let p1 = circle[i], p2 = circle[n - 1 - i];
        if ((i + state.currentRoundIdx) % 2 === 0) paired.push({ white: p1, black: p2, result: null });
        else paired.push({ white: p2, black: p1, result: null });
    }
    return paired;
}

/** Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ£Ø³ Ù…Ø¹ Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø« **/
/** Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ£Ø³ Ø§Ù„Ù…Ø·ÙˆØ± Ù„Ù…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ø§Ù„Ù…Ø³Ù…ÙŠØ§Øª **/
/** Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ£Ø³ Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ (Cup System) **/
function pairCup(parts) {
    let paired = [];
    
    // 1. Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø§Ù„Ø£ØµÙ„ÙŠ
    // ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„ÙƒØ£Ø³ØŒ Ø¹Ø¯Ø¯ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª = log2 Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ù…Ù‚Ø±Ø¨Ø§Ù‹ Ù„Ù„Ø£Ø¹Ù„Ù‰)
    const totalCupRounds = Math.ceil(Math.log2(state.players.length));
    const isLastRound = (state.currentRoundIdx + 1 === totalCupRounds);
    const isSemiFinalRound = (state.currentRoundIdx + 2 === totalCupRounds);

    // 2. Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø«
    // ØªØ¸Ù‡Ø± ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„Ø£Ø®ÙŠØ±Ø© Ø§Ù„Ù…Ø®Ø·Ø· Ù„Ù‡Ø§
    if (isLastRound && parts.length === 2) {
        let finalists = [...parts];
        let losersOfSemi = state.players.filter(p => p.eliminated && p.lastRoundLost === state.currentRoundIdx);
        
        paired.push({ 
            white: finalists[0], 
            black: finalists[1], 
            result: null, 
            type: 'Ù…Ø¨Ø§Ø±Ø§Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ğŸ†' 
        });

        if (losersOfSemi.length >= 2) {
            paired.push({ 
                white: losersOfSemi[0], 
                black: losersOfSemi[1], 
                result: null, 
                type: 'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø±ÙƒØ² Ø§Ù„Ø«Ø§Ù„Ø« ğŸ¥‰' 
            });
        }
    } 
    // 3. ØªØ³Ù…ÙŠØ© Ù†ØµÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…ØªØ¨Ù‚ÙŠÙ† ÙÙŠ Ø§Ù„Ø¬ÙˆÙ„Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø£Ø®ÙŠØ±Ø©
    else if (isSemiFinalRound && parts.length === 4) {
        for (let i = 0; i < parts.length; i += 2) {
            paired.push({ white: parts[i], black: parts[i+1], result: null, type: 'Ù†ØµÙ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ' });
        }
    }
    // 4. Ø§Ù„Ù…Ø²Ø§ÙˆØ¬Ø© Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ù„Ù„Ø£Ø¯ÙˆØ§Ø± Ø§Ù„ØªÙ…Ù‡ÙŠØ¯ÙŠØ©
    else {
        for (let i = 0; i < parts.length; i += 2) {
            if (parts[i+1]) {
                paired.push({ white: parts[i], black: parts[i+1], result: null });
            }
        }
    }
    return paired;
}
/** ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆØ§Ù„Ù€ SB **/
function updateResult(gameIdx, val) {
    let round = state.rounds[state.currentRoundIdx];
    let game = round.games[gameIdx];
    game.result = val;

    if (state.format === 'cup') {
        if (val === '1-0') { game.black.eliminated = true; game.black.lastRoundLost = state.currentRoundIdx + 1; }
        else if (val === '0-1') { game.white.eliminated = true; game.white.lastRoundLost = state.currentRoundIdx + 1; }
        else if (val === '0-0') { game.white.eliminated = true; game.black.eliminated = true; }
        if (val === '1/2-1/2') { alert("Ø§Ù„ÙƒØ£Ø³ ÙŠØªØ·Ù„Ø¨ ÙØ§Ø¦Ø²Ø§Ù‹!"); game.result = null; return; }
    }

    calculateStats();
    saveToLocalStorage();
    renderUI();
}

function calculateStats() {
    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 1: ØªØµÙÙŠØ± ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª ÙÙ‚Ø·
    state.players.forEach(p => { 
        p.points = 0; 
        p.sbScore = 0; 
        p.opponents = []; 
        p.colorBalance = 0; 
    });

    state.rounds.forEach(r => {
        if (r.bye) { 
            let p = state.players.find(x => x.id === r.bye.id); 
            if(p) p.points += 1; 
        }
        r.games.forEach(g => {
            let w = state.players.find(x => x.id === g.white.id);
            let b = state.players.find(x => x.id === g.black.id);
            if(!w || !b) return;
            w.opponents.push(b.id); 
            b.opponents.push(w.id);
            if (g.result === '1-0') { w.points += 1; w.colorBalance++; b.colorBalance--; }
            else if (g.result === '0-1') { b.points += 1; b.colorBalance++; w.colorBalance--; }
            else if (g.result === '1/2-1/2') { w.points += 0.5; b.points += 0.5; }
        });
    });

    // Ø§Ù„Ù…Ø±Ø­Ù„Ø© 2: Ø§Ù„Ø¢Ù† Ø¨Ø¹Ø¯ Ø£Ù† Ø§Ø³ØªÙ‚Ø±Øª Ù†Ù‚Ø§Ø· Ø§Ù„Ø¬Ù…ÙŠØ¹ØŒ Ù†Ø­Ø³Ø¨ Ø§Ù„Ù€ SB Ø¨Ø¯Ù‚Ø©
    if (state.format !== 'cup') {
        state.players.forEach(p => {
            state.rounds.forEach(r => {
                r.games.forEach(g => {
                    let isWhite = (g.white.id === p.id);
                    let isBlack = (g.black.id === p.id);
                    if (!isWhite && !isBlack) return; // Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„ÙŠØ³ Ø·Ø±ÙØ§Ù‹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ø±Ø§Ø©

                    let opp = isWhite ? state.players.find(x => x.id === g.black.id) : state.players.find(x => x.id === g.white.id);
                    if (!opp || !g.result) return;

                    // ØªØ·Ø¨ÙŠÙ‚ Ù‚ÙˆØ§Ø¹Ø¯ Sonneborn-Berger
                    if ((isWhite && g.result === '1-0') || (isBlack && g.result === '0-1')) {
                        p.sbScore += opp.points;
                    } else if (g.result === '1/2-1/2') {
                        p.sbScore += (opp.points * 0.5);
                    }
                });
            });
        });
    }
}
/** Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆÙ„Ø§Øª Ø§Ù„Ø³Ø§Ø¨Ù‚Ø© **/
function showHistory() {
    const historyContent = document.getElementById('historyContent');
    historyContent.innerHTML = state.rounds.map(r => `
        <div class="history-card">
            <h4>Ø§Ù„Ø¬ÙˆÙ„Ø© ${r.round}</h4>
            ${r.bye ? `<div class="bye-notice">Ø¥Ø¹ÙØ§Ø¡ (Bye): ${r.bye.name}</div>` : ''}
            ${r.games.map(g => `
                <div class="pairing-row" style="background: white;">
                    <span>${g.type ? `<b>[${g.type}]</b> ` : ''}${g.black.name}</span>
                    <span><b>${g.result || 'Ù„Ù… ØªÙ„Ø¹Ø¨'}</b></span>
                    <span>${g.white.name}</span>
                </div>
            `).join('')}
        </div>
    `).join('');
    document.getElementById('historyView').classList.remove('hidden');
    document.getElementById('activeRoundView').classList.add('hidden');
}

function hideHistory() {
    document.getElementById('historyView').classList.add('hidden');
    document.getElementById('activeRoundView').classList.remove('hidden');
}
function calculatePerformance(player) {
    if (!player.opponents || player.opponents.length === 0) return 0;

    let totalOppRating = 0;
    let playedGames = 0;

    // Ø¬Ù…Ø¹ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ø®ØµÙˆÙ… Ø§Ù„Ø°ÙŠÙ† Ù„Ø¹Ø¨ Ù…Ø¹Ù‡Ù… ÙØ¹Ù„ÙŠØ§Ù‹ (ØªØ¬Ø§Ù‡Ù„ Ø§Ù„Ù€ Bye)
    state.rounds.forEach(r => {
        r.games.forEach(g => {
            let opp = null;
            if (g.white.id === player.id) opp = state.players.find(p => p.id === g.black.id);
            else if (g.black.id === player.id) opp = state.players.find(p => p.id === g.white.id);
            
            if (opp) {
                totalOppRating += opp.rating;
                playedGames++;
            }
        });
    });

    if (playedGames === 0) return 0;

    let avgOppRating = totalOppRating / playedGames;
    let scorePercentage = player.points / state.currentRoundIdx;

    // Ø¬Ø¯ÙˆÙ„ ØªÙˆØ²ÙŠØ¹ ÙØ±Ù‚ Ø§Ù„Ù†Ù‚Ø§Ø· (FIDE dp table) Ø¨Ø´ÙƒÙ„ Ù…Ø¨Ø³Ø·
    let diff = 0;
    if (scorePercentage >= 0.5) diff = (scorePercentage - 0.5) * 800; 
    else diff = (0.5 - scorePercentage) * -800;

    return Math.round(avgOppRating + diff);
}
/** Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø±Ø¦ÙŠ **/
function renderUI() {
    const round = state.rounds[state.currentRoundIdx];
    if (!round) return;
    document.getElementById('roundTitle').innerText = `Ø§Ù„Ø¬ÙˆÙ„Ø© ${round.round}`;
    document.getElementById('byeContainer').innerHTML = round.bye ? `<div class="bye-notice">Ø¥Ø¹ÙØ§Ø¡ (Bye): ${round.bye.name} (+1 Ù†Ù‚Ø·Ø©)</div>` : '';

    const container = document.getElementById('pairingsContainer');
    container.innerHTML = round.games.map((g, i) => `
        <div class="pairing-row">
            <span>${g.type ? `<b style="color:var(--accent)">[${g.type}]</b> ` : ''}<b class="badge w">W</b> ${g.white.name} (${g.white.rating})</span>
            <select onchange="updateResult(${i}, this.value)">
                <option value="" ${!g.result ? 'selected' : ''}>--</option>
                <option value="1-0" ${g.result === '1-0' ? 'selected' : ''}>1 - 0</option>
                <option value="0-1" ${g.result === '0-1' ? 'selected' : ''}>0 - 1</option>
                ${state.format !== 'cup' ? `<option value="1/2-1/2" ${g.result === '1/2-1/2' ? 'selected' : ''}>Â½ - Â½</option>` : ''}
                <option value="0-0" ${g.result === '0-0' ? 'selected' : ''}>0 - 0</option>
            </select>
            <span>(${g.black.rating}) ${g.black.name} <b class="badge b">B</b></span>
        </div>
    `).join('');

    const allFinished = round.games.every(g => g.result);
    document.getElementById('nextRoundBtn').disabled = !allFinished || state.finished;

    const standings = [...state.players].sort((a, b) => b.points - a.points || b.sbScore - a.sbScore || b.rating - a.rating);
    document.querySelector('#standingsTable tbody').innerHTML = standings.map((p, i) => {
        
        // 1. Ø­Ø³Ø§Ø¨ ØªÙ‚ÙŠÙŠÙ… Ø§Ù„Ø£Ø¯Ø§Ø¡ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨
        const perfRating = calculatePerformance(p);
        const perfDisplay = perfRating > 0 ? perfRating : '-';

        return `
            <tr style="${p.eliminated ? 'color: #999; text-decoration: line-through;' : ''}">
                <td>${i + 1}</td>
                <td>${p.name} <span class="site-label">${p.displaySite}</span></td>
                <td>${p.rating}</td>
                <td><b>${p.points}</b></td>
                <td style="color: var(--accent); font-weight: bold;">${perfDisplay}</td>
                <td>${state.format === 'cup' ? (p.eliminated ? 'Ù…Ø³ØªØ¨Ø¹Ø¯' : 'Ù…Ø³ØªÙ…Ø±') : p.sbScore.toFixed(2)}</td>
            </tr>
        `;
    }).join('');
}

/** ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª **/
function saveToLocalStorage() {
    let archive = JSON.parse(localStorage.getItem('chess_v45_final') || '[]');
    const idx = archive.findIndex(t => t.id === state.id);
    if (idx > -1) archive[idx] = state; else archive.push(state);
    localStorage.setItem('chess_v45_final', JSON.stringify(archive));
}

function manualSave() { saveToLocalStorage(); alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨Ø·ÙˆÙ„Ø© Ø¨Ù†Ø¬Ø§Ø­!"); }

function loadArchive() {
    let archive = JSON.parse(localStorage.getItem('chess_v45_final') || '[]');
    showSection('archive');
    document.getElementById('archiveList').innerHTML = archive.map(t => `
        <div class="archive-item">
            <div><strong>${t.name}</strong><br><small>${t.format} - ${t.players.length} Ù„Ø§Ø¹Ø¨ÙŠÙ†</small></div>
            <div>
                <button class="btn-main" onclick="resumeTourney(${t.id})">ÙØªØ­</button>
                <button class="btn-danger" onclick="deleteTourney(${t.id})">Ø­Ø°Ù</button>
            </div>
        </div>
    `).join('') || "Ø§Ù„Ø³Ø¬Ù„ ÙØ§Ø±Øº Ø­Ø§Ù„ÙŠØ§Ù‹.";
}

function resumeTourney(id) {
    let archive = JSON.parse(localStorage.getItem('chess_v45_final') || '[]');
    state = archive.find(t => t.id === id);
    document.getElementById('displayTourneyName').innerText = state.name;
    showSection('tournamentArea');
    renderUI();
}

function deleteTourney(id) {
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) return;
    let arc = JSON.parse(localStorage.getItem('chess_v45_final') || '[]').filter(t => t.id !== id);
    localStorage.setItem('chess_v45_final', JSON.stringify(arc));
    loadArchive();
}

function confirmExit() { if(confirm("Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø±Ø¦ÙŠØ³ÙŠØ©ØŸ")) showSection('homeScreen'); }

function exportCSV() {
    let csv = "\uFEFFØ§Ù„Ù…Ø±ÙƒØ²,Ø§Ù„Ø§Ø³Ù…,Ø§Ù„ØªÙ‚ÙŠÙŠÙ…,Ø§Ù„Ù†Ù‚Ø§Ø·,SB\n";
    [...state.players].sort((a,b)=>b.points - a.points).forEach((p,i)=> {
        csv += `${i+1},${p.name},${p.rating},${p.points},${p.sbScore}\n`;
    });
    let blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    let link = document.createElement("a");
    link.href = URL.createObjectURL(blob);
    link.download = `${state.name}.csv`;
    link.click();
}
/** 1. Toggle UI Logic **/
function toggleTransferUI() {
    const section = document.getElementById('transferSection');
    section.classList.toggle('hidden');
}

/** 2. Export Logic: LocalStorage -> JSON File **/
function exportData() {
    try {
        // Fetch your specific data key (e.g., 'chess_v45_final')
        const data = localStorage.getItem('chess_v45_final');
        
        if (!data) {
            alert("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§.");
            return;
        }

        // Create a blob and trigger download
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        
        const timestamp = new Date().toISOString().slice(0, 10);
        a.href = url;
        a.download = `chess_backup_${timestamp}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    } catch (error) {
        console.error("Export failed:", error);
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
    }
}

/** 3. Import Logic: JSON File -> LocalStorage **/
function importData(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            
            // Validate JSON structure
            const parsedData = JSON.parse(content);
            
            // User Confirmation
            const confirmImport = confirm("ØªØ­Ø°ÙŠØ±: Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø³ÙŠÙ‚ÙˆÙ… Ø¨Ø§Ø³ØªØ¨Ø¯Ø§Ù„ ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ");
            
            if (confirmImport) {
                // Update Local Storage
                localStorage.setItem('chess_v45_final', JSON.stringify(parsedData));
                alert("ØªÙ… Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª.");
                location.reload(); // Refresh to load new data into state
            }
        } catch (error) {
            alert("ÙØ´Ù„ Ø§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯: Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø®ØªØ§Ø± ØºÙŠØ± ØµØ§Ù„Ø­ Ø£Ùˆ ØªØ§Ù„Ù.");
            console.error("Import Error:", error);
        }
    };
    
    reader.readAsText(file);
    // Reset input so the same file can be uploaded twice if needed
    event.target.value = '';
}
</script>
</body>
</html>